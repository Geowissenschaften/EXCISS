#!/bin/bash
###############################################################################
#
# exciss_increment_cycle.sh
#
#
# Increment EXCISS cycle counter and reconfigure symlinks in EXCISS_HOME
#
# Usage: exciss_increment_cycle.sh
#
# Parameters:
#   <none>
#
# Default location: /opt/exciss/mission/bin/exciss_increment_cycle.sh
#
# Requires files/binaries:
#   $EXCISS_HOME/etc/exciss_env
#   $EXCISS_HOME/var/exciss_cycle_number.cf
#
# Requires gloval variables:
#   $EXCISS_HOME
#
# Returns:
#   {true|false}
#
# If not started as root user requires sudo permissions for:
#   chown
#
# Invoked by: /etc/rc.local (as root)
#
###############################################################################
# set -x
unalias -a

typeset -i EXCISS_CYCLE_COUNT_NOW=0

EXCISS_HOME="/opt/exciss"
EXCISS_HOME="/home/jk/Desktop/2017_Exciss/EXCISS_USB_Transfer/mission"


EXCISS_CYCLE_VAR_FILE="${EXCISS_HOME}/var/exciss_cycle_number.cf"
EXCISS_CYCLE_VAR_NAME="EXCISS_CYCLE_COUNT"

EXCISS_CYCLE_COUNT_LAST="$(awk -F "=" -v VAR="${EXCISS_CYCLE_VAR_NAME}" \
	'$1 ~ "^[ \t]*"VAR"[ \t]*$" {gsub("^[ \t]*", "", $2); print substr($2, 1, match($2, "[ \t]*#")-1)}' \
	${EXCISS_CYCLE_VAR_FILE})"

EXCISS_CYCLE_COUNT_COMMENT="$(awk -F "#" -v VAR="${EXCISS_CYCLE_VAR_NAME}" \
	'$1 ~ "^[ \t]*"VAR"[ \t]*=" {gsub("^[ \t]*", "", $2); print $2}' \
	${EXCISS_CYCLE_VAR_FILE})"

EXCISS_CYCLE_COUNT_NOW=${EXCISS_CYCLE_COUNT_LAST}+1
EXCISS_CYCLE_VAR_NEW="${EXCISS_CYCLE_VAR_NAME}=${EXCISS_CYCLE_COUNT_NOW} # ${EXCISS_CYCLE_COUNT_COMMENT}"

echo EXCISS_CYCLE_VAR_NAME: "*"$EXCISS_CYCLE_VAR_NAME"*"
echo EXCISS_CYCLE_COUNT_LAST: "*"$EXCISS_CYCLE_COUNT_LAST"*"
echo EXCISS_CYCLE_COUNT_COMMENT: "*"$EXCISS_CYCLE_COUNT_COMMENT"*"
echo
echo EXCISS_CYCLE_VAR_NEW: "$EXCISS_CYCLE_VAR_NEW"

